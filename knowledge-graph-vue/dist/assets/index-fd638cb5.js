var $=(q,o,p)=>new Promise((c,g)=>{var C=m=>{try{y(p.next(m))}catch(r){g(r)}},N=m=>{try{y(p.throw(m))}catch(r){g(r)}},y=m=>m.done?c(m.value):Promise.resolve(m.value).then(C,N);y((p=p.apply(q,o)).next())});import{c_ as G,m as U,bU as H,Y as v,H as Q,O as h,P as b,Q as i,R as s,S as e,c$ as X,ac as L,y as x,V as k,W as Y,bD as J,$ as F,a0 as ee,F as ae,ah as le,d0 as te,U as R,h as n,bV as B,bW as se,bX as w,M as re}from"./index-4af02034.js";import{_ as ie}from"./CommonPage-69c64d74.js";import{_ as I}from"./QueryBarItem-dcb782ba.js";import{u as ue,_ as de,N as A}from"./CrudModal-4ad1e7dc.js";import{C as ne,_ as oe,f as pe,h as me,i as ve}from"./CrudTable-77c6359e.js";import{N as _}from"./Input-a430a206.js";import{N as fe,a as f}from"./FormItem-f234d31c.js";import{N as P}from"./Switch-2f74c195.js";import{N as ce}from"./TreeSelect-99fbe1e1.js";import{_ as ge}from"./Tree-73292cf6.js";import"./AppPage-24725091.js";import"./download-953ccaa2.js";const he=G(!0),_e=R("h1",null,"部门列表",-1),ye=R("br",null,null,-1),Ve=Object.assign({name:"用户管理"},{__name:"index",setup(q){const o=U(null),p=U({}),c=H("permission"),{modalVisible:g,modalTitle:C,modalAction:N,modalLoading:y,handleSave:m,modalForm:r,modalFormRef:T,handleEdit:O,handleDelete:E,handleAdd:K}=ue({name:"用户",initForm:{},doCreate:v.createUser,doUpdate:v.updateUser,doDelete:v.deleteUser,refresh:()=>{var l;return(l=o.value)==null?void 0:l.handleSearch()}}),D=U([]),S=U([]);Q(()=>{var l;(l=o.value)==null||l.handleSearch(),v.getRoleList({page:1,page_size:9999}).then(a=>D.value=a.data),v.getDepts().then(a=>S.value=a.data)});const Z=[{title:"名称",key:"username",width:60,align:"center",ellipsis:{tooltip:!0}},{title:"邮箱",key:"email",width:60,align:"center",ellipsis:{tooltip:!0}},{title:"用户角色",key:"role",width:60,align:"center",render(l){var t;const a=(t=l.roles)!=null?t:[],u=[];for(let d=0;d<a.length;d++)u.push(n(B,{type:"info",style:{margin:"2px 3px"}},{default:()=>a[d].name}));return n("span",u)}},{title:"部门",key:"dept.name",align:"center",width:40,ellipsis:{tooltip:!0}},{title:"超级用户",key:"is_superuser",align:"center",width:40,render(l){return n(B,{type:"info",style:{margin:"2px 3px"}},{default:()=>l.is_superuser?"是":"否"})}},{title:"上次登录时间",key:"last_login",align:"center",width:80,ellipsis:{tooltip:!0},render(l){return n(k,{size:"small",type:"text",ghost:!0},{default:()=>l.last_login!==null?se(l.last_login):null,icon:w("mdi:update",{size:16})})}},{title:"禁用",key:"is_active",width:50,align:"center",render(l){return n(P,{size:"small",rubberBand:!1,value:l.is_active,loading:!!l.publishing,checkedValue:!1,uncheckedValue:!0,onUpdateValue:()=>M(l)})}},{title:"操作",key:"actions",width:80,align:"center",fixed:"right",render(l){return[x(n(k,{size:"small",type:"primary",style:"margin-right: 8px;",onClick:()=>{var a;O(l),r.value.dept_id=(a=l.dept)==null?void 0:a.id,r.value.role_ids=l.roles.map(u=>u=u.id),delete r.value.dept}},{default:()=>"编辑",icon:w("material-symbols:edit",{size:16})}),[[c,"post/api/v1/user/update"]]),n(A,{onPositiveClick:()=>E({user_id:l.id},!1),onNegativeClick:()=>{}},{trigger:()=>x(n(k,{size:"small",type:"error",style:"margin-right: 8px;"},{default:()=>"删除",icon:w("material-symbols:delete-outline",{size:16})}),[[c,"delete/api/v1/user/delete"]]),default:()=>n("div",{},"确定删除该用户吗?")}),!l.is_superuser&&n(A,{onPositiveClick:()=>$(this,null,function*(){var a;try{yield v.resetPassword({user_id:l.id}),$message.success("密码已成功重置为123456"),yield(a=o.value)==null?void 0:a.handleSearch()}catch(u){$message.error("重置密码失败: "+u.message)}}),onNegativeClick:()=>{}},{trigger:()=>x(n(k,{size:"small",type:"warning",style:"margin-right: 8px;"},{default:()=>"重置密码",icon:w("material-symbols:lock-reset",{size:16})}),[[c,"post/api/v1/user/reset_password"]]),default:()=>n("div",{},"确定重置用户密码为123456吗?")})]}}];function M(l){return $(this,null,function*(){var t,d;if(!l.id)return;if(re().userId===l.id){$message.error("当前登录用户不可禁用！");return}l.publishing=!0,l.is_active=l.is_active===!1,l.publishing=!1;const u=[];l.roles.forEach(V=>{u.push(V.id)}),l.role_ids=u,l.dept_id=(t=l.dept)==null?void 0:t.id;try{yield v.updateUser(l),$message==null||$message.success(l.is_active?"已取消禁用该用户":"已禁用该用户"),(d=o.value)==null||d.handleSearch()}catch(V){l.is_active=l.is_active===!1}finally{l.publishing=!1}})}let z=null;const W=({option:l})=>({onClick(){var a;z===l.id?((a=o.value)==null||a.handleSearch(),z=null):v.getUserList({dept_id:l.id}).then(u=>{o.value.tableData=u.data,z=l.id})}}),j={username:[{required:!0,message:"请输入名称",trigger:["input","blur"]}],email:[{required:!0,message:"请输入邮箱地址",trigger:["input","change"]},{trigger:["blur"],validator:(l,a,u)=>{if(!/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(r.value.email)){u("邮箱格式错误");return}u()}}],password:[{required:!0,message:"请输入密码",trigger:["input","blur","change"]}],confirmPassword:[{required:!0,message:"请再次输入密码",trigger:["input"]},{trigger:["blur"],validator:(l,a,u)=>{if(a!==r.value.password){u("两次密码输入不一致");return}u()}}],roles:[{type:"array",required:!0,message:"请至少选择一个角色",trigger:["blur","change"]}]};return(l,a)=>{const u=ge;return h(),b(e(te),{"has-sider":"","wh-full":""},{default:i(()=>[s(e(X),{bordered:"","content-style":"padding: 24px;","collapsed-width":0,width:240,"show-trigger":"arrow-circle"},{default:i(()=>[_e,ye,s(u,{"block-line":"",data:S.value,"key-field":"id","label-field":"name","default-expand-all":"","node-props":W},null,8,["data"])]),_:1}),s(e(he),null,{default:i(()=>[s(ie,{"show-footer":"",title:"用户列表"},{action:i(()=>[]),default:i(()=>[s(ne,{ref_key:"$table",ref:o,"query-items":p.value,"onUpdate:queryItems":a[4]||(a[4]=t=>p.value=t),columns:Z,"get-data":e(v).getUserList},{queryBar:i(()=>[s(I,{label:"名称","label-width":40},{default:i(()=>[s(e(_),{value:p.value.username,"onUpdate:value":a[0]||(a[0]=t=>p.value.username=t),clearable:"",type:"text",placeholder:"请输入用户名称",onKeypress:a[1]||(a[1]=L(t=>{var d;return(d=o.value)==null?void 0:d.handleSearch()},["enter"]))},null,8,["value"])]),_:1}),s(I,{label:"邮箱","label-width":40},{default:i(()=>[s(e(_),{value:p.value.email,"onUpdate:value":a[2]||(a[2]=t=>p.value.email=t),clearable:"",type:"text",placeholder:"请输入邮箱",onKeypress:a[3]||(a[3]=L(t=>{var d;return(d=o.value)==null?void 0:d.handleSearch()},["enter"]))},null,8,["value"])]),_:1})]),add:i(()=>[x((h(),b(e(k),{style:{position:"absolute",right:"50px",top:"36px"},type:"primary",onClick:e(K)},{default:i(()=>[s(oe,{icon:"material-symbols:add",size:18,class:"mr-5"}),Y("新建用户 ")]),_:1},8,["onClick"])),[[e(c),"post/api/v1/user/create"]])]),_:1},8,["query-items","get-data"]),s(de,{visible:e(g),"onUpdate:visible":a[13]||(a[13]=t=>J(g)?g.value=t:null),title:e(C),loading:e(y),onSave:e(m)},{default:i(()=>[s(e(fe),{ref_key:"modalFormRef",ref:T,"label-placement":"left","label-align":"left","label-width":80,model:e(r),rules:j},{default:i(()=>[s(e(f),{label:"用户名称",path:"username"},{default:i(()=>[s(e(_),{value:e(r).username,"onUpdate:value":a[5]||(a[5]=t=>e(r).username=t),clearable:"",placeholder:"请输入用户名称"},null,8,["value"])]),_:1}),s(e(f),{label:"邮箱",path:"email"},{default:i(()=>[s(e(_),{value:e(r).email,"onUpdate:value":a[6]||(a[6]=t=>e(r).email=t),clearable:"",placeholder:"请输入邮箱"},null,8,["value"])]),_:1}),e(N)==="add"?(h(),b(e(f),{key:0,label:"密码",path:"password"},{default:i(()=>[s(e(_),{value:e(r).password,"onUpdate:value":a[7]||(a[7]=t=>e(r).password=t),"show-password-on":"mousedown",type:"password",clearable:"",placeholder:"请输入密码"},null,8,["value"])]),_:1})):F("",!0),e(N)==="add"?(h(),b(e(f),{key:1,label:"确认密码",path:"confirmPassword"},{default:i(()=>[s(e(_),{value:e(r).confirmPassword,"onUpdate:value":a[8]||(a[8]=t=>e(r).confirmPassword=t),"show-password-on":"mousedown",type:"password",clearable:"",placeholder:"请确认密码"},null,8,["value"])]),_:1})):F("",!0),s(e(f),{label:"角色",path:"role_ids"},{default:i(()=>[s(e(pe),{value:e(r).role_ids,"onUpdate:value":a[9]||(a[9]=t=>e(r).role_ids=t)},{default:i(()=>[s(e(me),{"item-style":"display: flex;"},{default:i(()=>[(h(!0),ee(ae,null,le(D.value,t=>(h(),b(e(ve),{key:t.id,value:t.id,label:t.name},null,8,["value","label"]))),128))]),_:1})]),_:1},8,["value"])]),_:1}),s(e(f),{label:"超级用户",path:"is_superuser"},{default:i(()=>[s(e(P),{value:e(r).is_superuser,"onUpdate:value":a[10]||(a[10]=t=>e(r).is_superuser=t),size:"small","checked-value":!0,"unchecked-value":!1},null,8,["value"])]),_:1}),s(e(f),{label:"禁用",path:"is_active"},{default:i(()=>[s(e(P),{value:e(r).is_active,"onUpdate:value":a[11]||(a[11]=t=>e(r).is_active=t),"checked-value":!1,"unchecked-value":!0,"default-value":!0},null,8,["value"])]),_:1}),s(e(f),{label:"部门",path:"dept_id"},{default:i(()=>[s(e(ce),{value:e(r).dept_id,"onUpdate:value":a[12]||(a[12]=t=>e(r).dept_id=t),options:S.value,"key-field":"id","label-field":"name",placeholder:"请选择部门",clearable:"","default-expand-all":""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title","loading","onSave"])]),_:1})]),_:1})]),_:1})}}});export{Ve as default};

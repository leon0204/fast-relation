var P=(F,f,d)=>new Promise((m,v)=>{var U=r=>{try{b(d.next(r))}catch(_){v(_)}},q=r=>{try{b(d.throw(r))}catch(_){v(_)}},b=r=>r.done?m(r.value):Promise.resolve(r.value).then(U,q);b((d=d.apply(F,f)).next())});import{m as n,bU as Z,Y as p,H as ee,O as z,P as x,Q as s,y,S as e,V as g,R as l,W as R,ac as ae,bD as te,h as c,bV as le,bW as se,bX as S}from"./index-4af02034.js";import{_ as oe}from"./CommonPage-69c64d74.js";import{_ as ie}from"./QueryBarItem-dcb782ba.js";import{u as re,_ as ne,N as de}from"./CrudModal-4ad1e7dc.js";import{_ as B,C as ue}from"./CrudTable-77c6359e.js";import{N as D}from"./Input-a430a206.js";import{N as pe,a as E}from"./FormItem-f234d31c.js";import{N as me,a as ce,b as fe,c as K}from"./Grid-eb15a981.js";import{a as ve,N as L}from"./Tabs-e05b3ede.js";import{_ as j}from"./Tree-73292cf6.js";import"./AppPage-24725091.js";import"./download-953ccaa2.js";import"./Add-5786f0d6.js";const qe=Object.assign({name:"角色管理"},{__name:"index",setup(F){const f=n(null),d=n({}),m=Z("permission"),{modalVisible:v,modalAction:U,modalTitle:q,modalLoading:b,handleAdd:r,handleDelete:_,handleEdit:G,handleSave:M,modalForm:k,modalFormRef:W}=re({name:"角色",initForm:{},doCreate:p.createRole,doDelete:p.deleteRole,doUpdate:p.updateRole,refresh:()=>{var o;return(o=f.value)==null?void 0:o.handleSearch()}}),C=n(""),I=n([]),A=n(!1),w=n([]),T=n(0),O=n([]),$=n([]),V=n([]);function H(o){const a=[],t={};return o.forEach(i=>{const u=i.tags,N=i.path.split("/").slice(0,-1).join("/"),Y=u.charAt(0).toUpperCase()+u.slice(1),J=i.method.toLowerCase()+i.path;N in t||(t[N]={unique_id:N,path:N,summary:Y,children:[]}),t[N].children.push({id:i.id,path:i.path,method:i.method,summary:i.summary,unique_id:J})}),a.push(...Object.values(t)),a}ee(()=>{var o;(o=f.value)==null||o.handleSearch()});const Q=[{title:"角色名",key:"name",width:80,align:"center",ellipsis:{tooltip:!0},render(o){return c(le,{type:"info"},{default:()=>o.name})}},{title:"角色描述",key:"desc",width:80,align:"center"},{title:"创建日期",key:"created_at",width:60,align:"center",render(o){return c("span",se(o.created_at))}},{title:"操作",key:"actions",width:80,align:"center",fixed:"right",render(o){return[y(c(g,{size:"small",type:"primary",style:"margin-right: 8px;",onClick:()=>{G(o)}},{default:()=>"编辑",icon:S("material-symbols:edit-outline",{size:16})}),[[m,"post/api/v1/role/update"]]),c(de,{onPositiveClick:()=>_({role_id:o.id},!1),onNegativeClick:()=>{}},{trigger:()=>y(c(g,{size:"small",type:"error",style:"margin-right: 8px;"},{default:()=>"删除",icon:S("material-symbols:delete-outline",{size:16})}),[[m,"delete/api/v1/role/delete"]]),default:()=>c("div",{},"确定删除该角色吗?")}),y(c(g,{size:"small",type:"primary",onClick:()=>P(this,null,function*(){try{const[a,t,i]=yield Promise.all([p.getMenus({page:1,page_size:9999}),p.getApis({page:1,page_size:9999}),p.getRoleAuthorized({id:o.id})]);I.value=a.data,O.value=H(t.data),w.value=i.data.menus.map(u=>u.id),$.value=i.data.apis.map(u=>u.method.toLowerCase()+u.path),A.value=!0,T.value=o.id}catch(a){console.error("Error loading data:",a)}})},{default:()=>"设置权限",icon:S("material-symbols:edit-outline",{size:16})}),[[m,"get/api/v1/role/authorized"]])]}}];function X(){return P(this,null,function*(){const o=V.value.getCheckedData(),a=[];o&&o.options.forEach(h=>{h.children||a.push({path:h.path,method:h.method})});const{code:t,msg:i}=yield p.updateRoleAuthorized({id:T.value,menu_ids:w.value,api_infos:a});t===200?$message==null||$message.success("设置成功"):$message==null||$message.error(i);const u=yield p.getRoleAuthorized({id:T.value});w.value=u.data.menus.map(h=>h.id)})}return(o,a)=>(z(),x(oe,{"show-footer":"",title:"角色列表"},{action:s(()=>[y((z(),x(e(g),{type:"primary",onClick:e(r)},{default:s(()=>[l(B,{icon:"material-symbols:add",size:18,class:"mr-5"}),R("新建角色 ")]),_:1},8,["onClick"])),[[e(m),"post/api/v1/role/create"]])]),default:s(()=>[l(ue,{ref_key:"$table",ref:f,"query-items":d.value,"onUpdate:queryItems":a[2]||(a[2]=t=>d.value=t),columns:Q,"get-data":e(p).getRoleList},{queryBar:s(()=>[l(ie,{label:"角色名","label-width":50},{default:s(()=>[l(e(D),{value:d.value.role_name,"onUpdate:value":a[0]||(a[0]=t=>d.value.role_name=t),clearable:"",type:"text",placeholder:"请输入角色名",onKeypress:a[1]||(a[1]=ae(t=>{var i;return(i=f.value)==null?void 0:i.handleSearch()},["enter"]))},null,8,["value"])]),_:1})]),add:s(()=>[y((z(),x(e(g),{style:{position:"absolute",right:"50px",top:"36px"},type:"primary",onClick:e(r)},{default:s(()=>[l(B,{icon:"material-symbols:add",size:18,class:"mr-5"}),R("新建角色 ")]),_:1},8,["onClick"])),[[e(m),"post/api/v1/role/create"]])]),_:1},8,["query-items","get-data"]),l(ne,{visible:e(v),"onUpdate:visible":a[5]||(a[5]=t=>te(v)?v.value=t:null),title:e(q),loading:e(b),onSave:e(M)},{default:s(()=>[l(e(pe),{ref_key:"modalFormRef",ref:W,"label-placement":"left","label-align":"left","label-width":80,model:e(k),disabled:e(U)==="view"},{default:s(()=>[l(e(E),{label:"角色名",path:"name",rule:{required:!0,message:"请输入角色名称",trigger:["input","blur"]}},{default:s(()=>[l(e(D),{value:e(k).name,"onUpdate:value":a[3]||(a[3]=t=>e(k).name=t),placeholder:"请输入角色名称"},null,8,["value"])]),_:1}),l(e(E),{label:"角色描述",path:"desc"},{default:s(()=>[l(e(D),{value:e(k).desc,"onUpdate:value":a[4]||(a[4]=t=>e(k).desc=t),placeholder:"请输入角色描述"},null,8,["value"])]),_:1})]),_:1},8,["model","disabled"])]),_:1},8,["visible","title","loading","onSave"]),l(e(me),{show:A.value,"onUpdate:show":a[9]||(a[9]=t=>A.value=t),placement:"right",width:500},{default:s(()=>[l(e(ce),null,{header:s(()=>[R(" 设置权限 ")]),default:s(()=>[l(e(fe),{"x-gap":"24",cols:"12"},{default:s(()=>[l(e(K),{span:"8"},{default:s(()=>[l(e(D),{value:C.value,"onUpdate:value":a[6]||(a[6]=t=>C.value=t),type:"text",placeholder:"筛选",style:{"flex-grow":"1"}},null,8,["value"])]),_:1}),l(e(K),{offset:"2"},{default:s(()=>[y((z(),x(e(g),{type:"info",onClick:X},{default:s(()=>[R("确定")]),_:1})),[[e(m),"post/api/v1/role/authorized"]])]),_:1})]),_:1}),l(e(ve),null,{default:s(()=>[l(e(L),{name:"menu",tab:"菜单权限","display-directive":"show"},{default:s(()=>[l(e(j),{data:I.value,"checked-keys":w.value,pattern:C.value,"show-irrelevant-nodes":!1,"key-field":"id","label-field":"name",checkable:"","default-expand-all":!0,"block-line":!0,selectable:!1,"onUpdate:checkedKeys":a[7]||(a[7]=t=>w.value=t)},null,8,["data","checked-keys","pattern"])]),_:1}),l(e(L),{name:"resource",tab:"接口权限","display-directive":"show"},{default:s(()=>[l(e(j),{ref_key:"apiTree",ref:V,data:O.value,"checked-keys":$.value,pattern:C.value,"show-irrelevant-nodes":!1,"key-field":"unique_id","label-field":"summary",checkable:"","default-expand-all":!0,"block-line":!0,selectable:!1,cascade:"","onUpdate:checkedKeys":a[8]||(a[8]=t=>$.value=t)},null,8,["data","checked-keys","pattern"])]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1}))}});export{qe as default};

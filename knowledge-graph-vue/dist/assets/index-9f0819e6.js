var A=(F,f,n)=>new Promise((m,v)=>{var R=d=>{try{y(n.next(d))}catch(g){v(g)}},x=d=>{try{y(n.throw(d))}catch(g){v(g)}},y=d=>d.done?m(d.value):Promise.resolve(d.value).then(R,x);y((n=n.apply(F,f)).next())});import{m as r,bU as J,Y as p,H as Z,O as T,P as $,Q as o,y as w,S as e,V as N,R as l,W as P,ac as ee,bD as ae,h as c,bV as te,bW as le,bX as S}from"./index-4af02034.js";import{_ as se}from"./CommonPage-69c64d74.js";import{_ as oe}from"./QueryBarItem-dcb782ba.js";import{u as ie,_ as re,N as ne}from"./CrudModal-4ad1e7dc.js";import{_ as de,C as ue}from"./CrudTable-77c6359e.js";import{N as pe,a as me,b as ce,c as B}from"./Grid-eb15a981.js";import{_ as E}from"./Tree-73292cf6.js";import{N as z}from"./Input-a430a206.js";import{N as fe,a as K}from"./FormItem-f234d31c.js";import{a as ve,N as L}from"./Tabs-e05b3ede.js";import"./AppPage-24725091.js";import"./download-953ccaa2.js";import"./Add-5786f0d6.js";const qe=Object.assign({name:"角色管理"},{__name:"index",setup(F){const f=r(null),n=r({}),m=J("permission"),{modalVisible:v,modalAction:R,modalTitle:x,modalLoading:y,handleAdd:d,handleDelete:g,handleEdit:j,handleSave:G,modalForm:b,modalFormRef:M}=ie({name:"角色",initForm:{},doCreate:p.createRole,doDelete:p.deleteRole,doUpdate:p.updateRole,refresh:()=>{var s;return(s=f.value)==null?void 0:s.handleSearch()}}),C=r(""),I=r([]),D=r(!1),_=r([]),U=r(0),O=r([]),q=r([]),V=r([]);function W(s){const a=[],t={};return s.forEach(i=>{const u=i.tags,k=i.path.split("/").slice(0,-1).join("/"),X=u.charAt(0).toUpperCase()+u.slice(1),Y=i.method.toLowerCase()+i.path;k in t||(t[k]={unique_id:k,path:k,summary:X,children:[]}),t[k].children.push({id:i.id,path:i.path,method:i.method,summary:i.summary,unique_id:Y})}),a.push(...Object.values(t)),a}Z(()=>{var s;(s=f.value)==null||s.handleSearch()});const H=[{title:"角色名",key:"name",width:80,align:"center",ellipsis:{tooltip:!0},render(s){return c(te,{type:"info"},{default:()=>s.name})}},{title:"角色描述",key:"desc",width:80,align:"center"},{title:"创建日期",key:"created_at",width:60,align:"center",render(s){return c("span",le(s.created_at))}},{title:"操作",key:"actions",width:80,align:"center",fixed:"right",render(s){return[w(c(N,{size:"small",type:"primary",style:"margin-right: 8px;",onClick:()=>{j(s)}},{default:()=>"编辑",icon:S("material-symbols:edit-outline",{size:16})}),[[m,"post/api/v1/role/update"]]),c(ne,{onPositiveClick:()=>g({role_id:s.id},!1),onNegativeClick:()=>{}},{trigger:()=>w(c(N,{size:"small",type:"error",style:"margin-right: 8px;"},{default:()=>"删除",icon:S("material-symbols:delete-outline",{size:16})}),[[m,"delete/api/v1/role/delete"]]),default:()=>c("div",{},"确定删除该角色吗?")}),w(c(N,{size:"small",type:"primary",onClick:()=>A(this,null,function*(){try{const[a,t,i]=yield Promise.all([p.getMenus({page:1,page_size:9999}),p.getApis({page:1,page_size:9999}),p.getRoleAuthorized({id:s.id})]);I.value=a.data,O.value=W(t.data),_.value=i.data.menus.map(u=>u.id),q.value=i.data.apis.map(u=>u.method.toLowerCase()+u.path),D.value=!0,U.value=s.id}catch(a){console.error("Error loading data:",a)}})},{default:()=>"设置权限",icon:S("material-symbols:edit-outline",{size:16})}),[[m,"get/api/v1/role/authorized"]])]}}];function Q(){return A(this,null,function*(){const s=V.value.getCheckedData(),a=[];s&&s.options.forEach(h=>{h.children||a.push({path:h.path,method:h.method})});const{code:t,msg:i}=yield p.updateRoleAuthorized({id:U.value,menu_ids:_.value,api_infos:a});t===200?$message==null||$message.success("设置成功"):$message==null||$message.error(i);const u=yield p.getRoleAuthorized({id:U.value});_.value=u.data.menus.map(h=>h.id)})}return(s,a)=>(T(),$(se,{"show-footer":"",title:"角色列表"},{action:o(()=>[w((T(),$(e(N),{type:"primary",onClick:e(d)},{default:o(()=>[l(de,{icon:"material-symbols:add",size:18,class:"mr-5"}),P("新建角色 ")]),_:1},8,["onClick"])),[[e(m),"post/api/v1/role/create"]])]),default:o(()=>[l(ue,{ref_key:"$table",ref:f,"query-items":n.value,"onUpdate:queryItems":a[2]||(a[2]=t=>n.value=t),columns:H,"get-data":e(p).getRoleList},{queryBar:o(()=>[l(oe,{label:"角色名","label-width":50},{default:o(()=>[l(e(z),{value:n.value.role_name,"onUpdate:value":a[0]||(a[0]=t=>n.value.role_name=t),clearable:"",type:"text",placeholder:"请输入角色名",onKeypress:a[1]||(a[1]=ee(t=>{var i;return(i=f.value)==null?void 0:i.handleSearch()},["enter"]))},null,8,["value"])]),_:1})]),_:1},8,["query-items","get-data"]),l(re,{visible:e(v),"onUpdate:visible":a[5]||(a[5]=t=>ae(v)?v.value=t:null),title:e(x),loading:e(y),onSave:e(G)},{default:o(()=>[l(e(fe),{ref_key:"modalFormRef",ref:M,"label-placement":"left","label-align":"left","label-width":80,model:e(b),disabled:e(R)==="view"},{default:o(()=>[l(e(K),{label:"角色名",path:"name",rule:{required:!0,message:"请输入角色名称",trigger:["input","blur"]}},{default:o(()=>[l(e(z),{value:e(b).name,"onUpdate:value":a[3]||(a[3]=t=>e(b).name=t),placeholder:"请输入角色名称"},null,8,["value"])]),_:1}),l(e(K),{label:"角色描述",path:"desc"},{default:o(()=>[l(e(z),{value:e(b).desc,"onUpdate:value":a[4]||(a[4]=t=>e(b).desc=t),placeholder:"请输入角色描述"},null,8,["value"])]),_:1})]),_:1},8,["model","disabled"])]),_:1},8,["visible","title","loading","onSave"]),l(e(pe),{show:D.value,"onUpdate:show":a[9]||(a[9]=t=>D.value=t),placement:"right",width:500},{default:o(()=>[l(e(me),null,{header:o(()=>[P(" 设置权限 ")]),default:o(()=>[l(e(ce),{"x-gap":"24",cols:"12"},{default:o(()=>[l(e(B),{span:"8"},{default:o(()=>[l(e(z),{value:C.value,"onUpdate:value":a[6]||(a[6]=t=>C.value=t),type:"text",placeholder:"筛选",style:{"flex-grow":"1"}},null,8,["value"])]),_:1}),l(e(B),{offset:"2"},{default:o(()=>[w((T(),$(e(N),{type:"info",onClick:Q},{default:o(()=>[P("确定")]),_:1})),[[e(m),"post/api/v1/role/authorized"]])]),_:1})]),_:1}),l(e(ve),null,{default:o(()=>[l(e(L),{name:"menu",tab:"菜单权限","display-directive":"show"},{default:o(()=>[l(e(E),{data:I.value,"checked-keys":_.value,pattern:C.value,"show-irrelevant-nodes":!1,"key-field":"id","label-field":"name",checkable:"","default-expand-all":!0,"block-line":!0,selectable:!1,"onUpdate:checkedKeys":a[7]||(a[7]=t=>_.value=t)},null,8,["data","checked-keys","pattern"])]),_:1}),l(e(L),{name:"resource",tab:"接口权限","display-directive":"show"},{default:o(()=>[l(e(E),{ref_key:"apiTree",ref:V,data:O.value,"checked-keys":q.value,pattern:C.value,"show-irrelevant-nodes":!1,"key-field":"unique_id","label-field":"summary",checkable:"","default-expand-all":!0,"block-line":!0,selectable:!1,cascade:"","onUpdate:checkedKeys":a[8]||(a[8]=t=>q.value=t)},null,8,["data","checked-keys","pattern"])]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1}))}});export{qe as default};
